# Using Buildkite to build Omnibus Packages

<!-- MarkdownTOC -->

- Buildkite Dynamic Pipelines #dynamic-pipelines
  - [.buildkite/verify.pipeline.sh](#verify-pipeline)
  - [.buildkite/verify.adhoc.pipeline.sh](#verify-adhoc-pipeline)
  - [.buildkite/build-test-omnibus.sh](#build-test)
- [Artifact Publish Locations](#artifact-locations)
- [Triggering pull-request builds of chef](#triggering-pr)
- [Triggering release builds of chef](#triggering-release)
- [Triggering adhoc builds of chef](#triggering-adhoc)
  - [Building and/or testing subset of platforms using OMNIBUS_FILTER](#omnibus-filter)
- [Viewing the Pipeline YAML](#viewing-yaml)
- [Walk-through of what happens in the pipeline](#walk-through)

<!-- /MarkdownTOC -->



## Buildkite Dynamic Pipelines #dynamic-pipelines

### .buildkite/verify.pipeline.sh {#verify-pipeline}
### .buildkite/verify.adhoc.pipeline.sh {#verify-adhoc-pipeline}
### .buildkite/build-test-omnibus.sh {#build-test}

## Artifact Publish Locations {#artifact-locations}

Chef pipelines upload and make available the artifacts they create to the following locations.

Location | `verify` | `validate/release` | `validate/adhoc`
--- | --- | --- | ---
[Buildkite Artifacts](https://buildkite.com/docs/pipelines/artifacts) | Yes | Yes | Yes |
Artifactory | No | Yes | No

## Triggering pull-request builds of chef {#triggering-pr}

## Triggering release builds of chef {#triggering-release}

There are three ways to trigger chef's `validate/release` pipeline.

1. **Via the [trigger_pipeline:validate/release]() action.** 
2. **Via the Buildkite UI.** Triggering a release build [via the Buildkite UI](https://buildkite.com/docs/tutorials/getting-started#create-your-first-build) is useful when you need to trigger a fresh build out of band of a code change to your project.
3. **Via the Buildkite CLI.** If you have the [Buildkite CLI]() configured, you can trigger a release pipeline manually using the `bk build create` command.

```bash
bk build create --pipeline=chef/chef-main-validate-release
```

## Triggering adhoc builds of chef {#triggering-adhoc}

Since the approach to pull-request validation had changed by the introduction of omnibus builds of pull-requests, the adhoc pipeline will likely be used to test an omnibus build of an esoteric platform.

There are three ways we recommend to trigger you `validate/adhoc` pipeline.

1. **Via the [trigger_pipeline:omnibus/adhoc]() action.**
2. **Via the Buildkite UI.** Triggering a release build [via the Buildkite UI](https://buildkite.com/docs/tutorials/getting-started#create-your-first-build) is useful when you need to trigger a fresh build out of band of a code change to your project.
3. **Via the Buildkite CLI.** If you have the [Buildkite CLI]({{< ref "/docs/getting-started/integrations.md" >}}) configured, you can trigger a release pipeline manually using the `bk build create` command.

```bash
bk build create --pipeline=chef/chef-main-validate-adhoc
```

### Building and/or testing subset of platforms using OMNIBUS_FILTER {#omnibus-filter}

The `OMNIBUS_FILTER` feature of the expeditor-generated omnibus pipelines is supported by the dynamic buildkite pipeline. See the [OMNIBUS_FILTER](https://expeditor.chef.io/docs/pipelines/omnibus/#building-andor-testing-subset-of-platforms-using-omnibus_filter) section of the expeditor docs for a description of how that works.

## Viewing the Pipeline YAML {#viewing-yaml}

There are two ways of viewing the pipeline YAML that is generated by `.buildkite/verifiy.pipeline.sh`.

1. **Via the Buildkite UI.** Once a build has been triggered, navigate to the job and expand the `upload` step. There is a tab labeled `timeline` that will show the YAML generated by the dynamic pipeline.

2. **Via executing the script.** Generate the pipeline YAML by executing the script, passing the required environment variables.

```bash
export OMNIBUS_TOOLCHAIN_VERSION=3.0.0
export CHEF_FOUNDATION_VERSION=3.0.3
export BUILDKITE_ORGANIZATION_SLUG="chef" # or chef-oss
export BUILDKITE_PIPELINE_SLUG="chef-main-validate-release"
./.buildkite/verify.pipeline.sh
```

## Walk-through of what happens in the pipeline {#walk-through}

Let's break down the steps of an Omnibus Buildkite pipeline build and walk through all the processes.

1. **Parse the shim pipeline definition.** Our trigger step reads in the .expeditor/release.omnibus.yml shim pipeline definition file and performs the following sub-steps.
    1. **Determine on which platforms we need to build.** Expeditor reads through your [builder-to-testers-map](#builder-to-testers-map) setting and determines on which platform it needs to build. It also looks at the [fips-platforms](#fips-platforms) setting to determine whether or not to build with [FIPS](https://en.wikipedia.org/wiki/Federal_Information_Processing_Standards) compatibility.
    1. **Determine on which platforms we need to test.** While reading through your [builder-to-testers-map](#builder-to-testers-map) setting, Expeditor also determines on which platforms certain builds should be tested. It configures the jobs accordingly, using the [test-path](#test-path) or [test-path-windows](#test-path-windows) setting for each job as appropriate.
    1. **Determine whether or not to promote to current at the end.** Based on whether or not the `ADHOC` environment variable is set to `true`, Expeditor will tack a final step which will promote all the builds to the current channel in Artifactory.
1. **Build all the artifacts and publish them to the unstable channel.** An individual Buildkite job is created for each Omnibus build so that all the builds can occur in parallel. If the Omnibus build succeeds, the resulting artifact is published to the unstable channel of Chef's internal Artifactory.
1. **Create the Build Record.** Upon the completion of all the builds, a build record representing all the artifacts is created inside Artifactory.
1. **Test all of the artifacts.** Once the build record has been completed it is time to test the artifacts using the test script specified in either [test-path](#test-path) or [test-path-windows](#test-path-windows). Each test platform downloads the appropriate artifact (as determined by our [mixlib-install](https://github.com/chef/mixlib-install) logic) and tested.
1. **Promote to the current channel (release only).** Once all of the tests scripts have passed successfully, our builds are promoted to the current channel, where they can be consumed by early adopters and other beta/QA testers.