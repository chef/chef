---
driver:
  name: exec
  gui: false

transport:
  name: exec

provisioner:
  name: chef_infra
  product_name: chef
  # Use the binlinked chef-client from habitat package installed in workflow
  install_strategy: skip
  chef_binary: C:\\hab\\bin\\chef-client.bat
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true
  deprecations_as_errors: true
  chef_license: accept-no-persist
  slow_resource_report: true

verifier:
  name: inspec
  format: progress

lifecycle:
  pre_converge:
    - remote: |
        Write-Host "Verifying chef-client from Habitat package:"
        chef-client --version
        if ($LASTEXITCODE -ne 0) {
            Write-Error "chef-client not available"
            Exit 1
        }
    - remote: |
        # Create a wrapper at <Drive>:\bin\chef-client.bat to satisfy exec script invocation
        $root = (Get-Location).Drive.Root
        $binDir = Join-Path $root 'bin'
        New-Item -ItemType Directory -Force -Path $binDir | Out-Null
        $wrapperPath = Join-Path $binDir 'chef-client.bat'
        $content = "@echo off`r`n"
        $content += "chef-client %*`r`n"
        Set-Content -Path $wrapperPath -Value $content -Encoding ASCII
        Write-Host "Ensured wrapper: $wrapperPath"
  post_converge:
    - remote: |
        $scriptPath = Join-Path (Get-Location) 'scripts\windows_post_converge.ps1'
        if (-not (Test-Path $scriptPath)) {
          Write-Error "Script not found: $scriptPath"
          exit 1
        }
        & $scriptPath
        if ($LASTEXITCODE -ne 0) {
          exit $LASTEXITCODE
        }

platforms:
  - name: windows-2022
  - name: windows-2025

suites:
  - name: end-to-end
    run_list:
      - recipe[end_to_end::default]
