---
driver:
  name: exec
  gui: false

transport:
  name: exec

provisioner:
  name: chef_infra
  product_name: chef
  # Use the binlinked chef-client from habitat package installed in workflow
  install_strategy: skip
  chef_binary: C:\\hab\\bin\\chef-client.bat
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true
  deprecations_as_errors: true
  chef_license: accept-no-persist
  slow_resource_report: true

verifier:
  name: inspec
  format: progress

lifecycle:
  pre_converge:
    - remote: |
        Write-Host "Verifying chef-client from Habitat package:"
        chef-client --version
        if ($LASTEXITCODE -ne 0) {
            Write-Error "chef-client not available"
            Exit 1
        }
    - remote: |
        # Create a wrapper at <Drive>:\bin\chef-client.bat to satisfy exec script invocation
        $root = (Get-Location).Drive.Root
        $binDir = Join-Path $root 'bin'
        New-Item -ItemType Directory -Force -Path $binDir | Out-Null
        $wrapperPath = Join-Path $binDir 'chef-client.bat'
        $content = "@echo off`r`n"
        $content += "chef-client %*`r`n"
        Set-Content -Path $wrapperPath -Value $content -Encoding ASCII
        Write-Host "Ensured wrapper: $wrapperPath"
  post_converge:
    - remote: |
        $clientDir = "C:\chef"
        New-Item -ItemType Directory -Force -Path $clientDir | Out-Null
        $content = 'chef_server_url "https://localhost/organizations/test"' + "`n"
        $content += 'chef_license "accept"' + "`n"
        $content += 'rubygems_url "https://rubygems.org/"' + "`n"
        $content += "require 'aws-sdk'"
        Set-Content -Path (Join-Path $clientDir 'client.rb') -Value $content -Encoding UTF8

    - remote: |
        $targetDir = "C:\opscode\chef\embedded\bin"
        New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
        $candidates = @("C:\opscode\chef-workstation\embedded\bin\openssl.exe", "D:\opscode\chef-workstation\embedded\bin\openssl.exe")
        $openssl = $null
        foreach ($cand in $candidates) {
          if (Test-Path $cand) { $openssl = $cand; break }
        }
        if (-not $openssl) {
          $searchRoot = "C:\opscode"
          if (Test-Path $searchRoot) {
            $found = Get-ChildItem -Path $searchRoot -Recurse -Filter openssl.exe -ErrorAction SilentlyContinue | Where-Object { $_.FullName -match 'embedded\\bin' } | Select-Object -First 1
            if ($found) { $openssl = $found.FullName }
          }
        }
        if ($openssl) {
          Copy-Item -Path $openssl -Destination (Join-Path $targetDir 'openssl.exe') -Force
          Write-Host "Mapped openssl.exe to $targetDir"
        } else {
          Write-Warning "OpenSSL not found"
        }

    - remote: |
        $sslDir = "C:\ssl_test"
        New-Item -ItemType Directory -Force -Path $sslDir | Out-Null

        $opensslPath = "C:\opscode\chef\embedded\bin\openssl.exe"
        if (-not (Test-Path $opensslPath)) {
          Write-Error "openssl.exe not found at $opensslPath"
          exit 1
        }

        Push-Location $sslDir
        # Generate CA
        & $opensslPath genrsa -out ca.key 2048
        & $opensslPath req -x509 -new -nodes -key ca.key -subj "/CN=Test CA" -days 365 -out my_ca.crt
        # Generate leaf key/cert
        & $opensslPath genrsa -out my_signed_cert.key 2048
        & $opensslPath req -new -key my_signed_cert.key -subj "/CN=localhost" -out my_signed_cert.csr
        & $opensslPath x509 -req -in my_signed_cert.csr -CA my_ca.crt -CAkey ca.key -CAcreateserial -out my_signed_cert.crt -days 365 -sha256
        Pop-Location

        # Quick verify to mirror the test expectation
        $verify = & $opensslPath verify -CAfile "$sslDir\my_ca.crt" "$sslDir\my_signed_cert.crt"
        Write-Host "openssl verify output: $verify"

platforms:
  - name: windows-2022
  - name: windows-2025

suites:
  - name: end-to-end
    run_list:
      - recipe[end_to_end::default]
