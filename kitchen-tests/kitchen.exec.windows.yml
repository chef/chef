---
driver:
  name: exec
  gui: false

transport:
  name: exec

provisioner:
  name: chef_infra
  product_name: chef
  # Use the binlinked chef-client from habitat package installed in workflow
  install_strategy: skip
  chef_binary: C:\\hab\\bin\\chef-client.bat
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true
  deprecations_as_errors: true
  chef_license: accept-no-persist
  slow_resource_report: true

verifier:
  name: inspec
  format: progress

lifecycle:
  pre_converge:
    - remote: |
        Write-Host "Verifying chef-client from Habitat package:"
        chef-client --version
        if ($LASTEXITCODE -ne 0) {
            Write-Error "chef-client not available"
            Exit 1
        }
    - remote: |
        # Create a wrapper at <Drive>:\bin\chef-client.bat to satisfy exec script invocation
        $root = (Get-Location).Drive.Root
        $binDir = Join-Path $root 'bin'
        New-Item -ItemType Directory -Force -Path $binDir | Out-Null
        $wrapperPath = Join-Path $binDir 'chef-client.bat'
        $content = "@echo off`r`n"
        $content += "C:\hab\bin\chef-client.bat %*`r`n"
        Set-Content -Path $wrapperPath -Value $content -Encoding ASCII
        Write-Host "Ensured wrapper: $wrapperPath"
  post_converge:
    - remote: |
        $clientDir = "C:\chef"
        New-Item -ItemType Directory -Force -Path $clientDir | Out-Null
        $content = 'chef_server_url "https://localhost/organizations/test"' + "`n"
        $content += 'chef_license "accept"' + "`n"
        $content += 'rubygems_url "https://rubygems.org/"' + "`n"
        $content += "require 'aws-sdk'"
        Set-Content -Path (Join-Path $clientDir 'client.rb') -Value $content -Encoding UTF8

        $habExe = $(Get-Command hab).Source
        $opensslroot = $(hab pkg path core/openssl)
        $binOpenssl = $opensslroot + "\bin\openssl.exe"
        if (-not (Test-Path $binOpenssl)) {
          Write-Error "openssl.exe not found at expected location: $binOpenssl"
          exit 1
        }
        Write-Host "Using Habitat-based openssl... @ $binOpenssl"
        Write-Host "Using hab exe at $habExe"

        $sslDir = "C:\ssl_test"
        Write-Host "Using openssl at $binOpenssl"
        if (-not(Test-Path "$sslDir")) {
          New-Item -ItemType Directory -Force -Path $sslDir | Out-Null
        }
        Set-Content -Path "$sslDir\openssl_path.txt" -Value $binOpenssl -Encoding ASCII
        Write-Host "Wrote openssl path to $sslDir\openssl_path.txt"

        Write-Host "Setting the OPENSSL_CONF environment variable to the Habitat package's openssl.cnf"

        $opensslConf = Join-Path $opensslroot -ChildPath 'ssl\openssl.cnf'
        if (Test-Path $opensslConf) {
          $env:OPENSSL_CONF = $opensslConf
          Write-Host "Set OPENSSL_CONF to $opensslConf"
        } else {
          Write-Error "Could not find openssl.cnf at expected location: $opensslConf"
          exit 1
        }

        Push-Location $sslDir
        # Generate CA
        & $binOpenssl genrsa -out ca.key 2048
        & $binOpenssl req -x509 -new -nodes -key ca.key -subj "/CN=Test CA" -days 365 -out my_ca.crt
        # Generate leaf key/cert
        & $binOpenssl genrsa -out my_signed_cert.key 2048
        & $binOpenssl req -new -key my_signed_cert.key -subj "/CN=localhost" -out my_signed_cert.csr
        & $binOpenssl x509 -req -in my_signed_cert.csr -CA my_ca.crt -CAkey ca.key -CAcreateserial -out my_signed_cert.crt -days 365 -sha256
        Pop-Location

        # Quick verify to mirror the test expectation
        $verify = & $binOpenssl verify -CAfile "$sslDir\my_ca.crt" "$sslDir\my_signed_cert.crt"
        Write-Host "Leaving kitchen.exec.windows.yml - openssl verify output: $verify"

platforms:
  - name: windows-2022
  - name: windows-2025

suites:
  - name: end-to-end
    run_list:
      - recipe[end_to_end::default]
