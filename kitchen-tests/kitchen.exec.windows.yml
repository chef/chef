---
driver:
  name: exec
  gui: false
  customize:
    memory: 4096

transport:
  name: exec

lifecycle:
  pre_converge:
    - remote: iex ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.ps1'))
    - remote: C:\ProgramData\Habitat\hab.exe license accept
    - remote: C:\ProgramData\Habitat\hab.exe pkg install --binlink --force chef/chef-infra-client --channel unstable
    - remote: C:\ProgramData\Habitat\hab.exe --version
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client chef-client -v
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client ohai -v
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client bundle -v
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client gem install specific_install appbundler --no-doc
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client gem specific_install -l https://github.com/chef/appbundle-updater -b main
    - remote: If ($lastexitcode -ne 0) { Exit $lastexitcode }
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client appbundle-updater chef chef-infra-client <%= ENV['GITHUB_SHA']  || %x(git rev-parse HEAD).chomp %> --tarball --github <%= ENV['GITHUB_REPOSITORY']  || "chef/chef" %>
    - remote: If ($lastexitcode -ne 0) { Exit $lastexitcode }
    - remote: Write-Output "Installed Chef / Ohai release:"
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client chef-client -v
    - remote: If ($lastexitcode -ne 0) { Exit $lastexitcode }
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client ohai -v
    - remote: If ($lastexitcode -ne 0) { Exit $lastexitcode }
    # htmldiff and ldiff on windows cause a conflict with gems being loaded below. we remove thenm here.
    # - remote: if (Test-Path C:\opscode\chef\embedded\bin\htmldiff) { Remove-Item -Path C:\opscode\chef\embedded\bin\htmldiff; Remove-Item -Path C:\opscode\chef\embedded\bin\ldiff }
    - remote: C:\ProgramData\Habitat\hab.exe pkg exec chef/chef-infra-client bundle install --jobs=3 --retry=3
    - remote: If ($lastexitcode -ne 0) { Exit $lastexitcode }

platforms:
  - name: windows-2019
  - name: windows-2022
  - name: windows-2025
