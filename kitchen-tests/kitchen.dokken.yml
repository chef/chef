---
driver:
  name: dokken
  privileged: true
  # Even if we are using custom habitat package, this is still needed by dokken driver.
  chef_version: unstable
  # map habitat installation on host to the /bin/hab path for easy access
  binds:
    - /bin/hab:/bin/hab
  # Map the Habitat package for use in the container
  # Map the Habitat origin key for use in the container
  volumes:
    - /home/runner/work/chef/chef/kitchen-tests/chef-infra-client-latest.hart:/chef-infra-client-latest.hart
    - /home/runner/work/chef/chef/kitchen-tests/gha-key.tar.gz:/gha-key.tar.gz
    - /home/runner/work/chef/chef/kitchen-tests/hab_token:/hab_token

transport:
  name: dokken

provisioner:
  name: dokken
  # Use the custom habitat package we have built to run recipes
  # NOTE: This attribute is getting ignored by TKE, a bug so we have resorted to creating a symlink
  # chef_binary: hab pkg exec gha/chef-infra-client chef-client
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true
  chef_license: "accept-no-persist"
  chef_license_key: free-79df705d-b685-419a-8b68-88401f74ff72-3999
  #chef_license_server:
    #- http://hosted-license-service-lb-8000-606952349.us-west-2.elb.amazonaws.com:8000
  deprecations_as_errors: true
  slow_resource_report: true
  clean_dokken_sandbox: false

lifecycle:
  pre_converge:
    # back compat for pre-unified-/usr distros, do not add new OSes
    - remote: sudo ln -s /usr/bin/install /bin/install
      includes:
        - opensuse-leap-15
        - debian-11
    - remote: sudo yum install centos-release-scl
      includes:
        - centos-7
    - remote: scl enable devtoolset-7
      includes:
        - centos-7
        - oraclelinux-7
    - remote: hab license accept
    - remote: echo "****Importing Habitat Origin Key****"
    - remote: sh -c "cat /gha-key.tar.gz | hab origin key import"

    - remote: echo "****Checking for Habitat package****"
    - remote: sh -c "if [ ! -f /chef-infra-client-latest.hart ]; then echo 'Habitat package not found!'; exit 1; fi"

    - remote: echo "****Installing Habitat package for Chef Infra Client****"
    - remote: sh -c "hab pkg install /chef-infra-client-latest.hart --auth \"$(cat /hab_token)\""
    - remote: echo "****Installed chef-infra-client version:****"
    - remote: hab pkg exec gha/chef-infra-client chef-client -v

    # Create a symlink from chef/chef-infra-client package to custom built gha/chef-infra-client
    - remote: echo "****Creating symlink to use our custom package in test kitchen runs****"
    - remote: |
        sh -c "
        CUSTOM_PKG=$(hab pkg path gha/chef-infra-client)
        DEFAULT_PKG=$(hab pkg path chef/chef-infra-client)
        echo 'Custom pkg: '$CUSTOM_PKG
        echo 'Default pkg: '$DEFAULT_PKG

        mv $DEFAULT_PKG ${DEFAULT_PKG}.original
        ln -sf $CUSTOM_PKG $DEFAULT_PKG
        ls -la $DEFAULT_PKG
        "

platforms:
  - name: amazonlinux-2023
    driver:
      image: dokken/amazonlinux-2023
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: debian-13
    driver:
      image: dokken/debian-13
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN /usr/bin/apt-get update -y
        - RUN /usr/bin/apt-get install ifupdown -y # we need this for /etc/network/interfaces & ifconfig resource

  - name: debian-12
    driver:
      image: dokken/debian-12
      pid_one_command: /bin/systemd
      intermediate_instructions:
        - RUN /usr/bin/apt-get update -y
        - RUN /usr/bin/apt-get install ifupdown -y # we need this for /etc/network/interfaces & ifconfig resource

  - name: debian-11
    driver:
      image: dokken/debian-11
      pid_one_command: /bin/systemd
      intermediate_instructions:
        - RUN /usr/bin/apt-get update -y
        - RUN /usr/bin/apt-get install ifupdown -y # we need this for /etc/network/interfaces & ifconfig resource

  - name: almalinux-8
    driver:
      image: dokken/almalinux-8
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN mkdir /etc/sysconfig/network-scripts # missing from the alma image
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: almalinux-9
    driver:
      image: dokken/almalinux-9
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN mkdir /etc/sysconfig/network-scripts # missing from the alma image
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: almalinux-10
    driver:
      image: dokken/almalinux-10
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN mkdir /etc/sysconfig/network-scripts # missing from the alma image
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: rockylinux-8
    driver:
      image: dokken/rockylinux-8
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN mkdir -p /etc/sysconfig/network-scripts
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: rockylinux-9
    driver:
      image: dokken/rockylinux-9
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN mkdir -p /etc/sysconfig/network-scripts
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: rockylinux-10
    driver:
      image: dokken/rockylinux-10
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN mkdir -p /etc/sysconfig/network-scripts
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: oraclelinux-8
    driver:
      image: dokken/oraclelinux-8
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN dnf -y reinstall systemd
        - RUN mkdir /etc/sysconfig/network-scripts # missing from the oracle image
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: oraclelinux-9
    driver:
      image: dokken/oraclelinux-9
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN dnf -y reinstall systemd
        - RUN mkdir /etc/sysconfig/network-scripts # missing from the oracle image
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: oraclelinux-10
    driver:
      image: dokken/oraclelinux-10
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN dnf -y install e2fsprogs
        - RUN dnf -y reinstall systemd
        - RUN mkdir /etc/sysconfig/network-scripts # missing from the oracle image
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers

  - name: fedora-42
    driver:
      image: dokken/fedora-42
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN sed -i -e "s/Defaults.*requiretty.*/Defaults    !requiretty/g" /etc/sudoers
        - RUN dnf -y install python3-libdnf python3-dnf

  - name: ubuntu-22.04
    driver:
      image: dokken/ubuntu-22.04
      pid_one_command: /bin/systemd
      intermediate_instructions:
        - RUN /usr/bin/apt-get update -y
        - RUN /usr/bin/apt-get install ifupdown -y # we need this for /etc/network/interfaces & ifconfig resource testing

  - name: ubuntu-24.04
    driver:
      image: dokken/ubuntu-24.04
      pid_one_command: /bin/systemd
      intermediate_instructions:
        - RUN /usr/bin/apt-get update -y
        - RUN /usr/bin/apt-get install ifupdown -y # we need this for /etc/network/interfaces & ifconfig resource testing

  - name: opensuse-leap-15
    driver:
      image: dokken/opensuse-leap-15
      pid_one_command: /usr/lib/systemd/systemd
      intermediate_instructions:
        - RUN /usr/bin/zypper --non-interactive update
        - RUN /usr/bin/zypper --non-interactive install net-tools-deprecated # we need this for /etc/network/interfaces & ifconfig resource testing
