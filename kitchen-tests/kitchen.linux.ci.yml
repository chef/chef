---
driver:
  name: vagrant
  box_auto_update: true
  box_auto_prune: true

provisioner:
  name: chef_infra
  product_name: chef
  product_version: latest
  channel: unstable
  retry_on_exit_code:
    - 35 # 35 is the exit code signaling that the node is rebooting
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true
  deprecations_as_errors: true
  chef_license: accept-no-persist
  chef_license_key: free-58e5ca65-d1cc-4838-bb79-42aa40ed3623-3835
  slow_resource_report: true

lifecycle:
  pre_converge:
    - remote: sudo dnf install -y openssl cronie
      includes:
        - fedora-latest
    - remote: |
      curl https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.sh | sudo bash -s -- -c stable
      hab pkg install --binlink --force chef/chef-infra-client --channel unstable
      echo "Chef container's Chef / Ohai release:"
      hab pkg exec chef/chef-infra-clientchef-client -v
      hab pkg exec chef/chef-infra-clientohai -v
      echo "Installing appbundler and appbundle-updater gems:"
      sudo hab pkg exec chef/chef-infra-clientgem install appbundler appbundle-updater --no-doc
      echo "Updating Chef using appbundler-updater:"
      sudo hab pkg exec chef/chef-infra-client appbundle-updater chef chef <%= ENV['GITHUB_SHA']  || %x(git rev-parse HEAD).chomp %> --tarball --github <%= ENV['GITHUB_REPOSITORY']  || "chef/chef" %>
      hab pkg exec chef/chef-infra-client chef-client --chef-license accept
      echo "Installed Chef / Ohai release:"
      hab pkg exec chef/chef-infra-client chef-client -v
      hab pkg exec chef/chef-infra-client ohai -v

verifier:
  name: inspec
  format: progress

platforms:
  - name: almalinux-8
  - name: almalinux-9
  - name: amazonlinux-2023
  - name: debian-12
  - name: debian-11
  - name: fedora-latest
  - name: opensuse-leap-15
  - name: oracle-8
  - name: oracle-9
  - name: rockylinux-8
  - name: rockylinux-9
  - name: ubuntu-22.04
  - name: ubuntu-24.04

suites:
  - name: end-to-end
    run_list:
      - recipe[end_to_end::default]
