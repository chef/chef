#!/usr/bin/env ruby

$:.unshift(File.expand_path("../../lib", File.dirname(__FILE__)))

require "tmpdir"
require "bundler"
require "chef/mixin/shell_out"

include Chef::Mixin::ShellOut

github_repo = ARGV.shift
git_thing = ARGV.shift

chef_dir = File.expand_path("../..", File.dirname(__FILE__))

Dir.mktmpdir("chef-external-test") do |dir|
  git_url = "https://github.com/#{github_repo}"
  Dir.rmdir dir
  shell_out!("git clone #{git_url} #{dir}", live_stream: STDOUT)
  Dir.chdir(dir) do
    shell_out!("git checkout #{git_thing}", live_stream: STDOUT)
    File.open("Gemfile", "a") { |f| f.write("\ngem 'chef', path: '#{chef_dir}'\n") }
    File.open("Gemfile", "a") { |f| f.write("gem 'ohai', git: 'https://github.com/chef/ohai.git', branch: 'master'\n") }
    Bundler.with_clean_env do
      shell_out!("bundle install", live_stream: STDOUT)
      shell_out!("bundle exec #{ARGV.join(" ")}", live_stream: STDOUT)
    end
  end
end
