language: ruby
cache: bundler

sudo: false
# Early warning system to catch if Rubygems breaks something
before_install:
  - gem update --system
  - gem install bundler

branches:
  only:
  - master
  - 10-stable
  - 11-stable

# do not run expensive spec tests on PRs, only on branches
script: "
set -e;
echo '--color\n-fp' > .rspec;
sudo sed -i -e 's/^Defaults\tsecure_path.*$//' /etc/sudoers;
sudo -E $(which bundle) exec rake spec;
bundle exec rake style;
bundle exec bundle-audit check --update;
"

env:
  global:
    - FORCE_FFI_YAJL=ext

matrix:
  include:
  - rvm: 2.2
    env: "GEMFILE_MOD=\"gem 'chef-zero', github: 'chef/chef-zero'\""
    script: bundle exec rake chef_zero_spec
  - rvm: 2.2
    env: "GEMFILE_MOD=\"gem 'chef-zero', github: 'chef/chef-zero'; gem 'github_changelog_generator', '1.11.3'\""
    script: bundle exec rake chef_zero_spec
  - rvm: 2.2
    env: "GEMFILE_MOD=\"gem 'chef-zero', github: 'chef/chef-zero'; gem 'github_changelog_generator', '1.10.1'\""
    script: bundle exec rake chef_zero_spec

  allow_failures:
    - rvm: rbx
notifications:
  on_change: true
  on_failure: true
  on_success: change
  on_pull_requests: false
  irc:
    channels:
    - chat.freenode.net#chef-hacking
  webhooks:
    urls:
    # Gitter IM
    - secure: HmMKr/ysKVyKUJ24PRCHcA8QCmlFoukrYumY0GRLzvaFWO8PknHO1t/0RbrKRb2ed/hgkFd+RKNCYvSvcE8Ahr2vlMrBeGHGfVeOGkWtbhLgNqo1b50Ll9CqvTM8X2ZIq6hIWraanwoYRQu/8uGL29yH4lBi7DhpTkFwBMLulhQ=
  hipchat:
    rooms:
    # Build Statuses
    - secure: G8MNo94L8bmWWwkH2/ViB2QaZnZHZscYM/mEjDbOGd15sqrruwckeARyBoUcRI7P1C6AFmS4IKCNVXa6KzX4Pbh51gQWM92zRpRTZpplwtXz53/1l8ajLFLLMLvEMTlBFAANUKEUFAQPY4dMa14V3Qc5oijfIncN61k4nZNTKpY=
    # Open Source
    - secure: hmcex4PpG5dn8WvjndONO4xCUKOC5kPU/bUEGRrfVbe2YKJE7t0XXbNDC96W/xBgzgnJzvf1Er0zJKDrNf4qEDEWFoozdN00WLcqREgaLLS3Seto2FjR/BpBk5q+sCV0rwwEMms2P4Qk+VSnDCnm9EaeM55hOabqNuOrRzoZLBQ=
