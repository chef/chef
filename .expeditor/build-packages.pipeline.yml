expeditor:
  accounts:
    - aws/chef-cd

steps:
  - label: ":linux: Build RPM package"
    commands:
      - pkg_identifier=$(sed 's/\//-/g' <<< $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX).tar.gz
      - export CHEF_INFRA_MIGRATE_TAR=s3://chef-hab-migration-tool-bucket/rc2_hab_pkg_chef_client/rc2_migration_tool/migration-tools_Linux_x86_64.tar.gz
      - export CHEF_INFRA_HAB_TAR=s3://chef-hab-migration-tool-bucket/rc2_hab_pkg_chef_client/rc2_tar_folder/$pkg_identifier
      - ./.expeditor/scripts/build-infra-rpm.sh
      - pkg_name=$(cat RPM_PKG_NAME)
      - buildkite-agent artifact upload $pkg_name
      - aws s3 cp $pkg_name s3://chef-hab-migration-tool-bucket/rc2_hab_pkg_chef_client/rc2_installer_folder/$pkg_name
    expeditor:
      executor:
        linux:
          privileged: true

  - label: ":linux: Build Debian package"
    commands:
      - pkg_identifier=$(sed 's/\//-/g' <<< $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX).tar.gz
      - export CHEF_INFRA_MIGRATE_TAR=s3://chef-hab-migration-tool-bucket/rc2_hab_pkg_chef_client/rc2_migration_tool/migration-tools_Linux_x86_64.tar.gz
      - export CHEF_INFRA_HAB_TAR=s3://chef-hab-migration-tool-bucket/rc2_hab_pkg_chef_client/rc2_tar_folder/$pkg_identifier
      - ./.expeditor/scripts/build-infra-deb.sh
      - pkg_name=$(cat DEB_PKG_NAME)
      - buildkite-agent artifact upload $pkg_name
      - aws s3 cp $pkg_name s3://chef-hab-migration-tool-bucket/rc2_hab_pkg_chef_client/rc2_installer_folder/$pkg_name
    expeditor:
      executor:
        linux:
          privileged: true