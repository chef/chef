---
expeditor:
  defaults:
    buildkite:
      timeout_in_minutes: 60
      retry:
        automatic:
          limit: 1

steps:

- label: ":linux: Validate Linux"
  commands:
    - export EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX="chef/chef-infra-client/18.0.179/20221109103645"
    - sudo ./.expeditor/scripts/install-hab.sh x86_64-linux
    - echo "--- Installing $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX"
    - sudo hab pkg install $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX
    - sudo ./habitat/tests/test.sh $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX
  expeditor:
    executor:
      linux:
        privileged: true
        single-use: true

- label: ":linux: Validate Linux (kernel2)"
  commands:
    - export EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX="chef/chef-infra-client/18.0.179/20221109103648"
    - sudo ./.expeditor/scripts/install-hab.sh x86_64-linux-kernel2
    - echo "--- Installing $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUXKERNEL2"
    - sudo hab pkg install $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUXKERNEL2
    - sudo ./habitat/tests/test.sh $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUXKERNEL2
  expeditor:
    executor:
      linux:
        privileged: true
        single-use: true

- label: ":windows: Validate Habitat Builds of Chef Infra"
  commands:
    - $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64WINDOWS = 'chef/chef-infra-client/18.0.179/20221109104144'
    - . ./.expeditor/scripts/ensure-minimum-viable-hab.ps1
    - Write-Host "--- Installing $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64WINDOWS"
    - $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
    - hab pkg install $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64WINDOWS
    - . ./habitat/tests/test.ps1 -PackageIdentifier $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64WINDOWS
  agents:
    queue: default-windows-2019

# Wait for the package testing to succeed before promoting whatever was tested.
- wait

- label: ":habicat: Promoting packages to the current channel."
  commands:
    - hab pkg promote $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUX current x86_64-linux
    - hab pkg promote $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64LINUXKERNEL2 current x86_64-linux-kernel2
    - hab pkg promote $EXPEDITOR_PKG_IDENTS_CHEFINFRACLIENTX86_64WINDOWS current x86_64-windows
  expeditor:
    executor:
      docker:
    secrets:
      HAB_AUTH_TOKEN:
        path: account/static/habitat/chef-ci
        field: auth_token
