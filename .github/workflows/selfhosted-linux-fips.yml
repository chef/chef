---
name: linux-fips

"on":
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: selfhosted-fips-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux:
    strategy:
      fail-fast: false
    runs-on: [self-hosted, ubuntu-2204-pro-fips-tester]
    env:
      HAB_ORIGIN: gha # Set the dummy origin for this Github actions CI flow
      HAB_BLDR_CHANNEL: base-2025 # Explicitly set the builder channel
      HAB_REFRESH_CHANNEL: base-2025 # Explicitly set the refresh channel
      HAB_AUTH_TOKEN: ${{ secrets.HAB_AUTH_TOKEN }}

    steps:
      - name: 'Clean up any previous installs'
        id: cleanup
        run: |
          set +e
          if [ -d "/home/azureuser/actions-runner/_work/chef/chef" ]; then
            sudo rm -r /home/azureuser/actions-runner/_work/chef/chef/*
          fi
          set -e

      - name: Check out code
        uses: actions/checkout@v4
        with:
            clean: false

      - name: Install Habitat CLI
        run: |
          curl https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.sh | sudo bash -s -- -c stable
          sudo hab license accept
          sudo hab --version

      - name: Generate fake Habitat Origin Key
        run: |
          hab origin key generate "$HAB_ORIGIN"
          # Export the keys for later use
          hab origin key export "$HAB_ORIGIN" > "$HAB_ORIGIN-key.tar.gz"

      - name: Build Habitat Package
        run: |
          # Build the Habitat package
          hab pkg build .
          source ./results/last_build.env
          cp "./results/$pkg_artifact" chef-infra-client-latest.hart

      - name: Set up HAB token file
        run: |
          # Create a token file for habitat operations
          echo "${{ secrets.HAB_AUTH_TOKEN }}" > hab_token
          chmod 600 hab_token

      - name: Install Chef Infra Client Habitat Package
        run: |
          # Import the previously exported key
          cat "$HAB_ORIGIN-key.tar.gz" | sudo hab origin key import
          sudo hab pkg install ./chef-infra-client-latest.hart --auth "$(cat hab_token)"
          # Verify installation
          sudo hab pkg exec $HAB_ORIGIN/chef-infra-client chef-client -v

      - name: 'Verify FIPS is enabled on the system'
        run: |
          # Check if FIPS mode is enabled on the system
          OUTPUT=$(cat /proc/sys/crypto/fips_enabled)
          if [ "$OUTPUT" = "1" ]
          then
            echo "FIPS is enabled"
          else
            echo "FIPS is not enabled"
            exit 1
          fi

      - name: Run chef-client with FIPS
        run: |
          sudo hab pkg exec $HAB_ORIGIN/chef-infra-client chef-client -v

          # Verify cryptographic operations work as expected in FIPS mode
          echo "Verifying cryptographic operations in FIPS mode:"
          sudo hab pkg exec $HAB_ORIGIN/chef-infra-client ruby -e "
          begin
            require 'openssl'
            # Try MD5 hash (should fail in FIPS mode)
            hash = OpenSSL::Digest::MD5.hexdigest('test')
            puts 'FAIL: FIPS mode is NOT working - MD5 hash succeeded'
            exit 1
          rescue OpenSSL::OpenSSLError => e
            puts 'PASS: FIPS mode confirmed - MD5 hash correctly blocked'
            exit 0
          rescue => e
            puts 'ERROR: ' + e.message
            exit 2
          end"
          echo "âœ… FIPS mode is confirmed - MD5 was blocked as expected"
