---
name: linux-fips
permissions:
  contents: read

"on":
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: selfhosted-fips-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux:
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push'
    strategy:
      fail-fast: false
    runs-on: [self-hosted, x64, Linux, ubuntu-2404-pro-fips-tester]
    env:
      HAB_ORIGIN: gha # Set the dummy origin for this Github actions CI flow
      # HAB_BLDR_CHANNEL: base-2025 # Explicitly set the builder channel
      # HAB_REFRESH_CHANNEL: base-2025 # Explicitly set the refresh channel
      HAB_BLDR_CHANNEL: fips-testing
      HAB_STUDIO_SECRET_HAB_REFRESH_CHANNEL: fips-testing
      HAB_STUDIO_SECRET_HAB_FALLBACK_CHANNEL: base-2025
      HAB_AUTH_TOKEN: ${{ secrets.HAB_AUTH_TOKEN }}
      CHEF_LICENSE_KEY: free-79df705d-b685-419a-8b68-88401f74ff72-3999
    steps:
      - name: 'Clean up any previous installs'
        id: cleanup
        run: |
          set +e
          if [ -d "/home/azureuser/actions-runner/_work/chef/chef" ]; then
            sudo rm -r /home/azureuser/actions-runner/_work/chef/chef/*
          fi
          set -e

      - name: Check out code
        uses: actions/checkout@v4
        with:
            clean: false

      - name: Install Habitat CLI
        run: |
          curl https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.sh | sudo bash -s -- -c stable
          sudo hab license accept
          sudo hab --version

      - name: Generate fake Habitat Origin Key
        run: |
          hab origin key generate "$HAB_ORIGIN"
          # Export the keys for later use
          hab origin key export "$HAB_ORIGIN" > "$HAB_ORIGIN-key.tar.gz"

      - name: Build Habitat Package for Chef Infra Client
        run: |
          # Build the Habitat package
          hab pkg build .
          source ./results/last_build.env
          cp "./results/$pkg_artifact" chef-infra-client-latest.hart

      - name: Install Chef Infra Client Habitat Package
        run: |
          # Import the previously exported key
          cat "$HAB_ORIGIN-key.tar.gz" | sudo hab origin key import
          sudo hab pkg install ./chef-infra-client-latest.hart --auth "${{ secrets.HAB_AUTH_TOKEN }}"
          # Verify installation
          sudo hab pkg exec $HAB_ORIGIN/chef-infra-client chef-client -v

      - name: 'Verify FIPS is enabled on the system'
        run: |
          # Check if FIPS mode is enabled on the system
          OUTPUT=$(cat /proc/sys/crypto/fips_enabled)
          if [ "$OUTPUT" = "1" ]
          then
            echo "FIPS is enabled"
          else
            echo "FIPS is not enabled"
            exit 1
          fi

      - name: Test chef-client with FIPS
        run: |
          sudo hab pkg exec $HAB_ORIGIN/chef-infra-client chef-client -z --chef-license accept

          # Create a minimal cookbook structure
          mkdir -p /tmp/test_cookbook/recipes
          echo 'file "/tmp/test" do; content Digest::MD5.hexdigest("test"); end' > /tmp/test_cookbook/recipes/default.rb

          # Run chef-client in local mode, specifying cookbook_path via config option, expect recipe run to fail due to FIPS and md5 usage
          sudo bash -c "
            set -o pipefail
            hab pkg exec $HAB_ORIGIN/chef-infra-client -- chef-client -z \
              --config-option cookbook_path=/tmp \
              -o test_cookbook 2>&1 | tee /tmp/chef-client.log
            echo \$? > /tmp/chef-exit-code.txt
          " || true

          # Read the exit code from the file
          EXIT_CODE=$(cat /tmp/chef-exit-code.txt)

          # Check if the command failed AND the error is related to MD5/Digest
          if [ $EXIT_CODE -ne 0 ]; then
            echo "=== Chef-client failed as expected in FIPS mode ==="
            if grep -qi "Digest" /tmp/chef-client.log && \
               grep -qi "initialization" /tmp/chef-client.log; then
              echo "=== PASS: FIPS mode detected and enforced - MD5 blocked with Digest error ==="
              exit 0
            else
              echo "=== FAIL: Command failed but not due to FIPS/MD5 enforcement ==="
              echo "=== Log excerpt ==="
              tail -50 /tmp/chef-client.log
              echo "=== End log excerpt ==="
              exit 1
            fi
          else
            echo "=== FAIL: FIPS mode not working - chef-client succeeded when it should have failed ==="
            echo "=== Log excerpt ==="
            tail -50 /tmp/chef-client.log
            echo "=== End log excerpt ==="
            exit 1
          fi

      # This is self-hosted runner, so we need to clean up after ourselves
      - name: 'Cleanup self-hosted runner'
        if: always()  # Run even if previous steps fail
        run: |
          echo "=== Cleaning up test artifacts ==="

          # Remove test cookbook and files
          sudo rm -rf /tmp/test_cookbook
          sudo rm -f /tmp/test
          sudo rm -f /tmp/chef-client.log
          sudo rm -f /tmp/client.rb

          # Remove the installed Chef Infra Client package(s) from /hab/pkgs
          sudo rm -rf /hab/pkgs/$HAB_ORIGIN/chef-infra-client || true

          # Clean up Habitat build artifacts
          sudo rm -rf /hab/cache/artifacts/$HAB_ORIGIN-chef-infra-client-*.hart || true

          # Remove origin keys
          sudo rm -f /hab/cache/keys/$HAB_ORIGIN-*.* || true

          # Clean up any Chef local-mode cache
          sudo rm -rf /root/.chef/local-mode-cache || true
          sudo rm -rf /var/chef || true

          echo "=== Cleanup complete ==="
