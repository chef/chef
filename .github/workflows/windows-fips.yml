---
name: windows-fips
permissions:
  contents: read

"on":
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: windows-fips-${{ github.ref }}
  cancel-in-progress: true

jobs:
  windows:
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, windows-2025]
        ruby: ['3.4']
    runs-on: ${{ matrix.os }}
    env:
      HAB_ORIGIN: gha # Set the dummy origin for this Github actions CI flow
      # HAB_BLDR_CHANNEL: base-2025 # Explicitly set the builder channel
      # HAB_REFRESH_CHANNEL: base-2025 # Explicitly set the refresh channel
      HAB_BLDR_CHANNEL: fips-testing
      HAB_STUDIO_SECRET_HAB_REFRESH_CHANNEL: fips-testing
      HAB_STUDIO_SECRET_HAB_FALLBACK_CHANNEL: base-2025
      HAB_STUDIO_SECRET_HAB_PREFER_LOCAL_CHEF_DEPS: true
      HAB_AUTH_TOKEN: ${{ secrets.HAB_AUTH_TOKEN }}
      CHEF_LICENSE_KEY: free-79df705d-b685-419a-8b68-88401f74ff72-3999
    steps:
    - uses: actions/checkout@v4
    - name: 'Install Habitat CLI'
      run: |
        # Download and install Habitat CLI
        Invoke-WebRequest -Uri https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.ps1 -OutFile install-habitat.ps1
        .\install-habitat.ps1
        # Add hab to PATH
        $env:PATH = "C:\Program Files\Habitat;" + $env:PATH
        # Use GitHub's special environment file to persist the PATH across steps
        echo "PATH=$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        # Accept the license
        hab license accept
        hab --version

    - name: 'Generate Habitat Origin Key'
      run: |
        # Generate the origin key for signing packages
        hab origin key generate "$env:HAB_ORIGIN"

    - name: 'Build Habitat Package for Chef Infra Client'
      run: |
        # Build the package for current checkout
        hab pkg build .
        # Find the built package using relative paths
        $pkg_path = Get-ChildItem -Path "results" -Filter "$env:HAB_ORIGIN-chef-infra-client-*.hart" |
                    Sort-Object LastWriteTime -Descending |
                    Select-Object -First 1

        if ($pkg_path) {
            Write-Host "✓ Built package: $($pkg_path.Name)"
            Copy-Item $pkg_path.FullName -Destination "chef-infra-client-latest.hart"
            Write-Host "✓ Copied to chef-infra-client-latest.hart"
        } else {
            Write-Error "× No package built"
            Get-ChildItem -Path "results" -ErrorAction SilentlyContinue
            Exit 1
        }

    - name: 'Install Chef Infra Client Package'
      run: |
        # Install the package
        hab pkg install chef-infra-client-latest.hart

        # Print the version of the installed package
        hab pkg exec $env:HAB_ORIGIN/chef-infra-client chef-client --version

    - name: 'Enable FIPS via Windows registry'
      run: |
        $KeyPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy"
        $ValueName = "Enabled"
        $ValueData = 1  # Use integer instead of string

        # Create the key if it doesn't exist
        if (!(Test-Path $KeyPath)) {
          New-Item -Path $KeyPath -Force | Out-Null
        }

        # Set the Enabled value to 1
        Set-ItemProperty -Path $KeyPath -Name $ValueName -Value $ValueData -Type DWord -Force

        # Verify FIPS is enabled
        $fipsEnabled = (Get-ItemProperty -Path $KeyPath).Enabled
        Write-Host "FIPS Mode Enabled: $fipsEnabled"

        # Extra verification
        if ($fipsEnabled -ne 1) {
          Write-Error "Failed to enable FIPS mode in Windows registry"
          Exit 1
        }

    - name: 'Test chef-client with FIPS'
      run: |
        hab pkg exec $env:HAB_ORIGIN/chef-infra-client -- chef-client --version
        # Accept Chef license in local mode
        hab pkg exec $env:HAB_ORIGIN/chef-infra-client -- chef-client -z --chef-license accept

        # Create a minimal cookbook structure
        New-Item -ItemType Directory -Force -Path "$env:TEMP\test_cookbook\recipes" | Out-Null
        @"
        file 'C:\temp\test' do
          content Digest::MD5.hexdigest('test')
        end
        "@ | Set-Content -Path "$env:TEMP\test_cookbook\recipes\default.rb"

        # Run chef-client and capture output, expect it to fail due to FIPS and MD5 usage
        $logPath = "$env:TEMP\chef-client.log"
        $exitCode = 0

        try {
          hab pkg exec $env:HAB_ORIGIN/chef-infra-client -- chef-client -z `
            --config-option "cookbook_path=$env:TEMP" `
            -o test_cookbook 2>&1 | Tee-Object -FilePath $logPath
          $exitCode = $LASTEXITCODE
        } catch {
          $exitCode = 1
          $_ | Out-File -Append -FilePath $logPath
        }

        Write-Host "=== Test Results ==="
        Write-Host "Chef-client exit code: $exitCode"

        # Check if Infra Client run failed AND the error is related to MD5/Digest
        if ($exitCode -ne 0) {
          Write-Host "=== Chef-client failed as expected in FIPS mode ==="
          $logContent = Get-Content $logPath -Raw

          if ($logContent -match "(?i)Digest" -and $logContent -match "(?i)initialization") {
            Write-Host "=== PASS: FIPS mode detected and enforced - MD5 blocked with Digest error ==="
            exit 0
          } else {
            Write-Host "=== FAIL: Command failed but not due to FIPS/MD5 enforcement ==="
            Write-Host "=== Log excerpt ==="
            Get-Content $logPath -Tail 50
            Write-Host "=== End log excerpt ==="
            exit 1
          }
        } else {
          Write-Host "=== FAIL: FIPS mode not working - chef-client succeeded when it should have failed ==="
          Write-Host "=== Log excerpt ==="
          Get-Content $logPath -Tail 50
          Write-Host "=== End log excerpt ==="
          exit 1
        }

    - name: 'Cleanup artifacts on runner'
      if: always()
      run: |
        Write-Host "=== Cleaning up test artifacts ==="

        # Remove test cookbook and files
        Remove-Item -Path "$env:TEMP\test_cookbook" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\temp\test" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "$env:TEMP\chef-client.log" -Force -ErrorAction SilentlyContinue

        # Clean up Habitat artifacts
        Remove-Item -Path "hab_token" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "$env:HAB_ORIGIN-key.tar.gz" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "chef-infra-client-latest.hart" -Force -ErrorAction SilentlyContinue

        Write-Host "=== Cleanup complete ==="
